<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¨­å‚™æ‹¾ã„å‡ºã—ãƒ„ãƒ¼ãƒ« v9.0 Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --sidebar-width: 280px; }
        body { font-family: 'Segoe UI', Meiryo, sans-serif; margin: 0; display: flex; height: 100vh; background: #1a1a1a; color: white; overflow: hidden; }
        #sidebar { width: var(--sidebar-width); background: #252525; border-right: 2px solid #444; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; overflow-y: auto; z-index: 1000; }
        #main-content { flex: 1; display: flex; flex-direction: column; background: #333; position: relative; overflow: hidden; }
        #canvas-area { flex: 1; overflow: auto; padding: 20px; display: flex; align-items: flex-start; justify-content: center; }
        .page-container { position: relative; display: none; background: white; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        .page-container.active { display: block; }
        canvas { display: block; cursor: crosshair; }
        
        /* è©³ç´°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒ‘ãƒãƒ« */
        #counter-panel { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.9); border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 11px; z-index: 2000; min-width: 150px; line-height: 1.6; }
        .cnt-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; margin-bottom: 4px; }
        .cnt-val { font-weight: bold; color: #0f0; }

        /* ãƒã‚¹ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .mass-base { position: absolute; width: 26px; height: 26px; border: 2px solid #333; border-radius: 50%; background: white; transform: translate(-50%, -50%); pointer-events: none; z-index: 20; }
        .mass-branch::after { content: ""; position: absolute; top: 50%; left: 50%; width: 50%; height: 50%; background: #333; border-radius: 0 0 100% 0; }
        .mass-start::before { content: ""; position: absolute; top: 2px; left: 50%; width: 12px; height: 12px; border: 1.5px solid #333; border-radius: 50%; transform: translateX(-50%); }
        .mass-num-label { position: absolute; top: -12px; right: -12px; background: #e91e63; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; text-align: center; line-height: 16px; font-weight: bold; border: 1px solid white; }

        /* é…ç®¡ãƒ©ã‚¤ãƒ³ */
        .pipe-line { position: absolute; transform-origin: 0 50%; pointer-events: none; opacity: 0.8; z-index: 5; }
        .pipe-vu100 { height: 10px; background: #28a745; }
        .pipe-vu75  { height: 6px; background: #28a745; }
        .pipe-vu50  { height: 3px; background: #28a745; }
        .pipe-supply { height: 4px; background: #007bff; }
        .pipe-hot    { height: 4px; background: #ff4757; }
        .drawing-layer { position: absolute; top: 0; left: 0; z-index: 100; pointer-events: none; width: 100%; height: 100%; }

        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: bold; color: #888; margin-bottom: 5px; border-bottom: 1px solid #444; }
        button { width: 100%; padding: 8px; margin-bottom: 3px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 10px; text-align: left; background: #444; color: #ccc; }
        button.active-sel { background: #007bff; color: white; border: 1px solid #fff; }
        input[type="number"] { width: 100%; background: #333; color: white; border: 1px solid #555; padding: 5px; border-radius: 4px; font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="counter-panel">
    <div style="font-weight:bold; color:#ff9800; margin-bottom:5px;">ã€é›†è¨ˆçµæœã€‘</div>
    <div class="cnt-row"><span>VU100:</span> <span id="len-vu100" class="cnt-val">0.0</span>m / <span id="qty-vu100" class="cnt-val">0</span>ãƒ¶</div>
    <div class="cnt-row"><span>VU75:</span> <span id="len-vu75" class="cnt-val">0.0</span>m / <span id="qty-vu75" class="cnt-val">0</span>ãƒ¶</div>
    <div class="cnt-row"><span>VU50:</span> <span id="len-vu50" class="cnt-val">0.0</span>m / <span id="qty-vu50" class="cnt-val">0</span>ãƒ¶</div>
    <div class="cnt-row"><span>çµ¦æ°´:</span> <span id="len-supply" class="cnt-val">0.0</span>m / <span id="qty-supply" class="cnt-val">0</span>ãƒ¶</div>
    <div class="cnt-row"><span>çµ¦æ¹¯:</span> <span id="len-hot" class="cnt-val">0.0</span>m / <span id="qty-hot" class="cnt-val">0</span>ãƒ¶</div>
</div>

<div id="sidebar">
    <button style="background:#eee;color:#111;text-align:center" onclick="document.getElementById('file-input').click()">ğŸ“ å›³é¢èª­ã¿è¾¼ã¿</button>
    <input type="file" id="file-input" style="display:none;" accept=".pdf,image/*">
    
    <div class="sidebar-section">
        <div class="sidebar-title">å°ºè¨­å®š (1mã‚ãŸã‚Šã®ãƒ”ã‚¯ã‚»ãƒ«æ•°)</div>
        <input type="number" id="scale-px" value="100" onchange="updateCounters()">
    </div>

    <div class="sidebar-section">
        <div class="sidebar-title">é…ç®¡ç¨®åˆ¥</div>
        <button id="pipe-vu100" class="btn-pipe active-sel" onclick="setPipe('vu100')">ğŸŸ© æ’æ°´ VU100</button>
        <button id="pipe-vu75" class="btn-pipe" onclick="setPipe('vu75')">ç·š æ’æ°´ VU75</button>
        <button id="pipe-vu50" class="btn-pipe" onclick="setPipe('vu50')">ç·š æ’æ°´ VU50</button>
        <button id="pipe-supply" class="btn-pipe" onclick="setPipe('supply')">ğŸŸ¦ çµ¦æ°´ VP</button>
        <button id="pipe-hot" class="btn-pipe" onclick="setPipe('hot')">ğŸŸ¥ çµ¦æ¹¯ HT</button>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-title">ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</div>
        <button id="mode-mass" class="btn-mode active-sel" onclick="setMode('mass')">â¦¿ ãƒã‚¹é…ç½® (Rã§å›è»¢)</button>
        <button id="mode-manual" class="btn-mode" onclick="setMode('manual')">ğŸ“ æ‰‹å‹•é…ç®¡</button>
        <button id="mode-pen" class="btn-mode" onclick="setMode('pen')">ğŸ–Š è‡ªç”±æ‰‹æ›¸ã</button>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-title">ãƒã‚¹ç¨®åˆ¥</div>
        <button id="mtype-round" class="btn-mtype active-sel" onclick="setMassType('round')">â—‹ ä¸­é–“ãƒã‚¹</button>
        <button id="mtype-branch" class="btn-mtype" onclick="setMassType('branch')">â—‘ åˆ†å²ãƒã‚¹</button>
        <button id="mtype-start" class="btn-mtype" onclick="setMassType('start')">â¦¿ èµ·ç‚¹ãƒã‚¹</button>
    </div>

    <button style="background:#ff9800;color:#000;text-align:center" onclick="connectMasses()">âš¡ è‡ªå‹•æ¥ç¶š (èµ·ç‚¹ã¾ã§)</button>
    <button onclick="undo()" style="background:#6c757d;color:white;text-align:center;margin-top:10px;">â†© æˆ»ã™ (Ctrl+Z)</button>
    <button onclick="saveAsImage()" style="background:#28a745;color:white;text-align:center">ğŸ“¸ ä¿å­˜</button>
</div>

<div id="main-content">
    <div id="top-tabs"></div>
    <div id="canvas-area"></div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let currentPageId = null, pageData = {};
    let currentPipe = 'vu100', currentMode = 'mass', massType = 'round', currentRot = 0;
    let manualStart = null, isDrawing = false, currentPath = null;

    function setPipe(p) { currentPipe = p; updateUI(); }
    function setMode(m) { currentMode = m; manualStart = null; updateUI(); }
    function setMassType(t) { massType = t; currentMode = 'mass'; updateUI(); }

    function updateUI() {
        document.querySelectorAll('button').forEach(b => b.classList.remove('active-sel'));
        document.getElementById('pipe-'+currentPipe)?.classList.add('active-sel');
        document.getElementById('mode-'+currentMode)?.classList.add('active-sel');
        document.getElementById('mtype-'+massType)?.classList.add('active-sel');
    }

    function updateCounters() {
        const pxPerM = parseFloat(document.getElementById('scale-px').value) || 100;
        const stats = {
            vu100: {len:0, qty:0}, vu75: {len:0, qty:0}, vu50: {len:0, qty:0}, supply: {len:0, qty:0}, hot: {len:0, qty:0}
        };

        Object.values(pageData).forEach(data => {
            data.history.forEach(h => {
                if(h.isMass && stats[h.pipeType]) stats[h.pipeType].qty++;
                if(h.len && stats[h.pipeType]) stats[h.pipeType].len += h.len;
            });
        });

        for(let type in stats) {
            document.getElementById(`len-${type}`).innerText = (stats[type].len / pxPerM).toFixed(1);
            document.getElementById(`qty-${type}`).innerText = stats[type].qty;
        }
    }

    function handleDraw(x, y, container) {
        const data = pageData[currentPageId];
        if(currentMode === 'mass') {
            const num = data.history.filter(i => i.isMass).length + 1;
            const m = document.createElement('div');
            m.className = `mass-base mass-${massType}`;
            m.style.left = x + 'px'; m.style.top = y + 'px';
            m.style.transform = `translate(-50%, -50%) rotate(${currentRot}deg)`;
            const label = document.createElement('div');
            label.className = 'mass-num-label'; label.innerText = num;
            label.style.transform = `rotate(${-currentRot}deg)`;
            m.appendChild(label); container.appendChild(m);
            data.history.push({isMass:true, mode:massType, pos:{x,y}, rot:currentRot, pipeType:currentPipe, elements:[m]});
        } else if(currentMode === 'manual') {
            if(!manualStart) manualStart = {x, y};
            else { createLine(manualStart.x, manualStart.y, x, y, container, currentPipe); manualStart = null; }
        }
        updateCounters();
    }

    function connectMasses() {
        if (!currentPageId) return;
        const data = pageData[currentPageId];
        const container = document.getElementById('container-' + currentPageId);
        const massItems = data.history.filter(item => item.isMass);
        if (massItems.length < 2) return;

        for (let i = 0; i < massItems.length - 1; i++) {
            const s = massItems[i]; const e = massItems[i+1];
            createLine(s.pos.x, s.pos.y, e.pos.x, s.pos.y, container, currentPipe);
            createLine(e.pos.x, s.pos.y, e.pos.x, e.pos.y, container, currentPipe);
            if (e.mode === 'start') break;
        }
        massItems.forEach(item => {
            if (item.mode === 'branch') {
                const rad = (item.rot * Math.PI) / 180;
                createLine(item.pos.x, item.pos.y, item.pos.x + 40 * Math.cos(rad), item.pos.y + 40 * Math.sin(rad), container, currentPipe);
            }
        });
        updateCounters();
    }

    function createLine(x1, y1, x2, y2, container, type) {
        const dist = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
        if (dist < 2) return;
        const line = document.createElement('div');
        line.className = `pipe-line pipe-${type}`;
        line.style.width = dist + 'px'; line.style.left = x1 + 'px'; line.style.top = y1 + 'px';
        line.style.transform = `rotate(${Math.atan2(y2-y1, x2-x1)}rad) translateY(-50%)`;
        container.appendChild(line);
        pageData[currentPageId].history.push({isMass:false, pipeType:type, elements:[line], len: dist});
    }

    function createPageUI(id, topTabs, canvasArea) {
        const container = document.createElement('div'); container.id='container-'+id; container.className='page-container';
        const canvas = document.createElement('canvas'); canvas.id='canvas-'+id;
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("class", "drawing-layer");
        
        canvas.addEventListener('mousedown', (ev) => {
            if(currentMode === 'pen') {
                isDrawing = true;
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("stroke", currentPipe==='supply'?'#007bff':currentPipe==='hot'?'#ff4757':'#28a745');
                path.setAttribute("stroke-width", "3"); path.setAttribute("fill", "none");
                path.setAttribute("d", `M ${ev.offsetX} ${ev.offsetY}`);
                svg.appendChild(path); currentPath = path;
                pageData[id].history.push({isMass:false, pipeType:currentPipe, elements:[path], len:0});
            } else { handleDraw(ev.offsetX, ev.offsetY, container); }
        });

        window.addEventListener('mousemove', (ev) => {
            if(!isDrawing || currentMode !== 'pen' || !currentPath) return;
            const rect = canvas.getBoundingClientRect();
            const x = ev.clientX - rect.left; const y = ev.clientY - rect.top;
            if(x < 0 || x > canvas.width || y < 0 || y > canvas.height) return;
            currentPath.setAttribute("d", `${currentPath.getAttribute("d")} L ${x} ${y}`);
        });

        window.addEventListener('mouseup', () => { isDrawing = false; currentPath = null; });
        container.appendChild(canvas); container.appendChild(svg); canvasArea.appendChild(container);
        pageData[id] = { history:[] };
        const tab = document.createElement('div'); tab.innerText=id; tab.className='tab'; tab.onclick=()=>switchPage(id); topTabs.appendChild(tab);
    }

    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(){
            document.getElementById('top-tabs').innerHTML = ''; document.getElementById('canvas-area').innerHTML = '';
            if(file.type==="application/pdf"){
                const pdf = await pdfjsLib.getDocument({data: new Uint8Array(this.result)}).promise;
                for(let i=1; i<=pdf.numPages; i++){
                    const id='P'+i; createPageUI(id, document.getElementById('top-tabs'), document.getElementById('canvas-area'));
                    const page = await pdf.getPage(i); const vp = page.getViewport({scale:1.5});
                    const canvas = document.getElementById('canvas-'+id); canvas.width=vp.width; canvas.height=vp.height;
                    await page.render({canvasContext:canvas.getContext('2d'), viewport:vp}).promise;
                }
            } else {
                createPageUI('P1', document.getElementById('top-tabs'), document.getElementById('canvas-area'));
                const img = new Image(); img.onload=()=>{ const c=document.getElementById('canvas-P1'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0); }; img.src=URL.createObjectURL(file);
            }
            switchPage('P1');
        };
        reader.readAsArrayBuffer(file);
    };

    function switchPage(id) { currentPageId = id; document.querySelectorAll('.page-container').forEach(c=>c.classList.remove('active')); document.getElementById('container-'+id).classList.add('active'); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); [...document.querySelectorAll('.tab')].find(t=>t.innerText===id)?.classList.add('active'); }
    function undo() { if(!currentPageId) return; const h = pageData[currentPageId].history; if(h.length>0) h.pop().elements.forEach(e=>e.remove()); updateCounters(); }
    function saveAsImage() { const c = document.getElementById('container-'+currentPageId); html2canvas(c, {scale:2}).then(canvas => { const a = document.createElement('a'); a.href=canvas.toDataURL("image/jpeg",0.9); a.download="æ‹¾ã„å‡ºã—é›†è¨ˆ.jpg"; a.click(); }); }
    window.addEventListener('keydown', e => { if(e.key === 'r' || e.key === 'R') currentRot = (currentRot + 90) % 360; if(e.ctrlKey && e.key === 'z') undo(); });
</script>
</body>
</html>
