<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¨­å‚™æ‹¾ã„å‡ºã—ãƒ„ãƒ¼ãƒ« v10.14 (Eraser Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --sidebar-width: 280px; }
        body { font-family: 'Segoe UI', Meiryo, sans-serif; margin: 0; display: flex; height: 100vh; background: #1a1a1a; color: white; overflow: hidden; }
        #sidebar { width: var(--sidebar-width); background: #252525; border-right: 2px solid #444; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; overflow-y: auto; z-index: 1000; }
        #main-content { flex: 1; display: flex; flex-direction: column; background: #333; position: relative; overflow: hidden; }
        #top-tabs { display: flex; background: #222; border-bottom: 1px solid #444; overflow-x: auto; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border-right: 1px solid #444; background: #333; color: #aaa; font-size: 12px; font-weight: bold; }
        .tab-btn.active { background: #007bff; color: white; }
        #canvas-area { flex: 1; overflow: auto; padding: 20px; display: flex; align-items: flex-start; justify-content: center; position: relative; }
        .page-container { position: relative; display: none; background: white; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        .page-container.active { display: block; }
        canvas { display: block; cursor: crosshair; }
        
        /* æ‰‹æ›¸ãSVGãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¨­å®š */
        .drawing-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .drawing-svg path { pointer-events: stroke; cursor: pointer; }
        
        #line-preview { position: absolute; height: 2px; background: rgba(0, 210, 255, 0.5); pointer-events: none; transform-origin: 0 50%; z-index: 101; display: none; }

        #counter-panel { position: absolute; top: 50px; right: 10px; background: rgba(0,0,0,0.95); border: 1px solid #444; color: white; padding: 15px; border-radius: 8px; font-size: 11px; z-index: 2000; min-width: 210px; }
        #panel-close { position: absolute; top: 5px; right: 5px; cursor: pointer; background: #ff4757; border: none; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        #panel-open { position: absolute; top: 50px; right: 10px; display: none; background: #28a745; color: white; padding: 5px 12px; border-radius: 5px; cursor: pointer; z-index: 1999; }
        .cnt-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; }
        .cnt-val { font-weight: bold; color: #0f0; }

        .mass-base { position: absolute; width: 28px; height: 28px; border: 2px solid #333; border-radius: 50%; background: white; transform: translate(-50%, -50%); pointer-events: none; z-index: 20; display: flex; align-items: center; justify-content: center; color: #333; font-size: 11px; font-weight: bold; }
        .mass-kigu { border-radius: 4px; background: #fffde7; border: 2px solid #fbc02d; width: 32px; height: 32px; }
        .mass-num-label { position: absolute; top: -12px; right: -12px; background: #e91e63; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; text-align: center; line-height: 16px; border: 1px solid white; z-index: 30; }
        .pipe-line { position: absolute; transform-origin: 0 50%; pointer-events: none; opacity: 0.8; z-index: 5; }
        .pipe-vu100 { height: 10px; background: #28a745; }
        .pipe-vu75  { height: 6px; background: #28a745; }
        .pipe-vu50  { height: 4px; background: #28a745; }
        .pipe-supply { height: 4px; background: #007bff; }
        .pipe-hot    { height: 4px; background: #ff4757; }

        .sidebar-section { margin-bottom: 12px; }
        .sidebar-title { font-size: 11px; font-weight: bold; color: #888; margin-bottom: 5px; border-bottom: 1px solid #444; }
        button { width: 100%; padding: 8px; margin-bottom: 4px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 10px; text-align: left; background: #444; color: #ccc; }
        button.active-sel { background: #007bff; color: white; border: 1px solid #fff; }

        #pen-palette { display: none; background: #1a1a1a; padding: 8px; border-radius: 4px; margin-top: 5px; border: 1px solid #444; }
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 8px; }
        .color-dot { height: 20px; border-radius: 3px; cursor: pointer; border: 1px solid #333; }
        .color-dot.active { border: 2px solid white; transform: scale(1.1); }
        .size-grid { display: flex; gap: 4px; }
        .size-btn { flex: 1; padding: 6px 0; font-size: 9px; text-align: center; background: #444; border-radius: 3px; cursor: pointer; border: 1px solid #555; }
        .size-btn.active { background: #28a745; color: white; border-color: white; }
    </style>
</head>
<body>

<div id="panel-open" onclick="togglePanel(true)">ğŸ“Š é›†è¨ˆã‚’è¡¨ç¤º</div>
<div id="counter-panel">
    <button id="panel-close" onclick="togglePanel(false)">Ã—</button>
    <div style="font-weight:bold; color:#00d2ff; border-bottom:1px solid #00d2ff; margin-bottom:5px;">ã€é…ç®¡ãƒ»ç¶™æ‰‹ã€æ”¯æŒã€‘</div>
    <div class="cnt-row"><span>VU100(4mæ¯):</span> <span><span id="len-vu100" class="cnt-val">0.0</span>m / <span id="qty-vu100" class="cnt-val">0</span>ãƒ¶</span></div>
    <div class="cnt-row"><span>VU75(1mæ¯):</span> <span><span id="len-vu75" class="cnt-val">0.0</span>m / <span id="qty-vu75" class="cnt-val">0</span>ãƒ¶</span></div>
    <div class="cnt-row"><span>VU50(1mæ¯):</span> <span><span id="len-vu50" class="cnt-val">0.0</span>m / <span id="qty-vu50" class="cnt-val">0</span>ãƒ¶</span></div>
    <div class="cnt-row"><span>çµ¦æ°´ VP:</span> <span><span id="len-supply" class="cnt-val">0.0</span>m</span></div>
    <div class="cnt-row"><span>çµ¦æ¹¯ HT:</span> <span><span id="len-hot" class="cnt-val">0.0</span>m</span></div>
    <div style="font-weight:bold; color:#ff9800; border-bottom:1px solid #ff9800; margin-top:8px; margin-bottom:5px;">ã€å™¨å…·éƒ¨å“ã€‘</div>
    <div class="cnt-row"><span>ãƒãƒ«ãƒ–:</span> <span id="parts-valve" class="cnt-val" style="color:#ff9800">0</span> ãƒ¶</div>
    <div class="cnt-row"><span>ãƒ¦ãƒ‹ã‚ªãƒ³:</span> <span id="parts-union" class="cnt-val" style="color:#ff9800">0</span> ãƒ¶</div>
    <div class="cnt-row"><span>åºŠåº§æ°´S:</span> <span id="parts-toko-s" class="cnt-val" style="color:#ff9800">0</span> ãƒ¶</div>
    <div class="cnt-row"><span>å£åº§æ°´L:</span> <span id="parts-kabe-l" class="cnt-val" style="color:#ff9800">0</span> ãƒ¶</div>
</div>

<div id="sidebar">
    <button style="background:#eee;color:#111;text-align:center" onclick="document.getElementById('file-input').click()">ğŸ“ å›³é¢èª­ã¿è¾¼ã¿</button>
    <input type="file" id="file-input" style="display:none;" accept=".pdf,image/*">
    
    <div class="sidebar-section">
        <div class="sidebar-title">â‘  é…ç®¡ç¨®åˆ¥</div>
        <button id="pipe-vu100" onclick="setPipe('vu100')">ğŸŸ© VU100 (4mæ¯)</button>
        <button id="pipe-vu75" onclick="setPipe('vu75')">ç·š VU75 (1mæ¯)</button>
        <button id="pipe-vu50" onclick="setPipe('vu50')">ç·š VU50 (1mæ¯)</button>
        <button id="pipe-supply" onclick="setPipe('supply')">ğŸŸ¦ çµ¦æ°´ VP</button>
        <button id="pipe-hot" onclick="setPipe('hot')">ğŸŸ¥ çµ¦æ¹¯ HT</button>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-title">â‘¡ æç”»ãƒ¢ãƒ¼ãƒ‰</div>
        <button id="mode-manual" onclick="setMode('manual')">ğŸ“ ç›´ç·šé…ç®¡</button>
        <button id="mode-mass" onclick="setMode('mass')">ğŸ”˜ ãƒã‚¹/å™¨å…· é…ç½®</button>
        <button id="mode-pen" onclick="setMode('pen')" style="background:#e67e22; color:white;">ğŸ–Š è‡ªç”±æ‰‹æ›¸ã (æ³¨è¨˜)</button>
        
        <div id="pen-palette">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="font-size:9px; color:#aaa;">ãƒ„ãƒ¼ãƒ«</span>
                <button id="tool-eraser" onclick="setTool('eraser')" style="width:auto; padding:3px 8px; background:#555; font-size:9px; margin:0; text-align:center;">ğŸ§½ æ¶ˆã—ã‚´ãƒ </button>
            </div>
            <div class="color-grid">
                <div class="color-dot active" style="background:#000" onclick="setTool('pen'); updatePen('#000',null,this)"></div>
                <div class="color-dot" style="background:#f00" onclick="setTool('pen'); updatePen('#f00',null,this)"></div>
                <div class="color-dot" style="background:#00f" onclick="setTool('pen'); updatePen('#00f',null,this)"></div>
                <div class="color-dot" style="background:#28a745" onclick="setTool('pen'); updatePen('#28a745',null,this)"></div>
                <div class="color-dot" style="background:#ffc107" onclick="setTool('pen'); updatePen('#ffc107',null,this)"></div>
                <div class="color-dot" style="background:#9c27b0" onclick="setTool('pen'); updatePen('#9c27b0',null,this)"></div>
                <div class="color-dot" style="background:#fff" onclick="setTool('pen'); updatePen('#fff',null,this)"></div>
            </div>
            <div class="size-grid">
                <div id="size-thin" class="size-btn active" onclick="updatePen(null,2,this)">ç´°</div>
                <div id="size-mid"  class="size-btn" onclick="updatePen(null,6,this)">ä¸­</div>
                <div id="size-thick" class="size-btn" onclick="updatePen(null,14,this)">å¤ª</div>
            </div>
        </div>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-title">â‘¢ ãƒã‚¹ãƒ»å™¨å…· (Rã§å›è»¢)</div>
        <button id="mtype-round" onclick="setMassType('round')">â—‹ ãƒã‚¹</button>
        <button id="mtype-branch" onclick="setMassType('branch')">â—‘ åˆ†å²ãƒã‚¹</button>
        <button id="mtype-wash" onclick="setMassType('wash')">ğŸš¿ æ´—é¢</button>
        <button id="mtype-bath" onclick="setMassType('bath')">ğŸ› é¢¨å‘‚</button>
        <button id="mtype-sink" onclick="setMassType('sink')">ğŸ½ ã‚­ãƒƒãƒãƒ³</button>
        <button id="mtype-toilet" onclick="setMassType('toilet')">ğŸš½ ãƒˆã‚¤ãƒ¬</button>
        <button id="mtype-laundry" onclick="setMassType('laundry')">ğŸ§º æ´—æ¿¯æ©Ÿ</button>
    </div>

    <button onclick="undo()" style="background:#6c757d;color:white;text-align:center">â†© æˆ»ã™ (Ctrl+Z)</button>
    <button id="btn-mode-calib" onclick="setMode('calib')" style="background:#673ab7;color:white;text-align:center">ğŸ¯ 1mã‚’æŒ‡å®š</button>
    <input type="number" id="scale-px" value="100" style="display:none;">
    <button onclick="saveAsImage()" style="background:#28a745;color:white;text-align:center;margin-top:10px;">ğŸ“¸ ç”»åƒã¨ã—ã¦ä¿å­˜</button>
</div>

<div id="main-content">
    <div id="top-tabs"></div>
    <div id="canvas-area">
        <div id="line-preview"></div>
    </div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let currentPageId = null, pageData = {};
    let currentPipe = 'vu100', currentMode = 'manual', massType = 'round', currentRot = 0;
    let currentTool = 'pen'; 
    let activePen = { color: '#000', width: 2 };
    let manualStart = null, calibStart = null, isMouseDown = false, currentPath = null;

    const MASS_CONFIG = {
        round: { label: '', valve: 0, union: 0, tokoS: 0, kabeL: 0, kigu: false },
        branch: { label: '', valve: 0, union: 0, tokoS: 0, kabeL: 0, kigu: false },
        wash: { label: 'æ´—', valve: 2, union: 0, tokoS: 0, kabeL: 0, kigu: true },
        bath: { label: 'é¢¨', valve: 0, union: 2, tokoS: 0, kabeL: 0, kigu: true },
        sink: { label: 'å°', valve: 2, union: 0, tokoS: 0, kabeL: 0, kigu: true },
        toilet: { label: 'ä¾¿', valve: 0, union: 0, tokoS: 1, kabeL: 0, kigu: true },
        laundry: { label: 'æ©Ÿ', valve: 0, union: 0, tokoS: 0, kabeL: 1, kigu: true }
    };

    function setPipe(p) { currentPipe = p; updateUI(); }
    
    function setMode(m) { 
        currentMode = m; manualStart = null; calibStart = null; 
        document.getElementById('line-preview').style.display = 'none';
        document.getElementById('pen-palette').style.display = (m === 'pen') ? 'block' : 'none';
        
        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã«æ¶ˆã—ã‚´ãƒ ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        if (m !== 'pen') setTool('pen');
        updateUI(); 
    }

    // æ¶ˆã—ã‚´ãƒ ãƒ„ãƒ¼ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ
    function setTool(t) {
        currentTool = t;
        const eraserBtn = document.getElementById('tool-eraser');
        const svg = document.getElementById('svg-' + currentPageId);
        
        if (t === 'eraser') {
            eraserBtn.style.background = '#ff4757';
            if (svg) svg.style.pointerEvents = 'auto'; // æ¶ˆã—ã‚´ãƒ ã®æ™‚ã¯SVGãŒãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¥ªã†
        } else {
            eraserBtn.style.background = '#555';
            if (svg) svg.style.pointerEvents = 'none'; // ãƒšãƒ³ã®æ™‚ã¯Canvasã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’æµã™
        }
    }

    function updatePen(c, w, el) {
        if(c) { 
            activePen.color = c; 
            setTool('pen'); 
            document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active')); 
            el.classList.add('active'); 
        }
        if(w) { 
            activePen.width = w; 
            document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('active')); 
            el.classList.add('active'); 
        }
    }

    function setMassType(t) { massType = t; currentMode = 'mass'; updateUI(); }
    
    function togglePanel(show) {
        document.getElementById('counter-panel').style.display = show ? 'block' : 'none';
        document.getElementById('panel-open').style.display = show ? 'none' : 'block';
    }

    function updateUI() {
        document.querySelectorAll('button').forEach(b => b.classList.remove('active-sel'));
        document.getElementById('pipe-'+currentPipe)?.classList.add('active-sel');
        document.getElementById('mode-'+currentMode)?.classList.add('active-sel');
        if(currentMode === 'mass') document.getElementById('mtype-'+massType)?.classList.add('active-sel');
    }

    function getSnappedPos(x, y) {
        if (!currentPageId) return {x, y};
        const target = pageData[currentPageId].history.find(h => h.isMass && Math.sqrt((h.pos.x - x)**2 + (h.pos.y - y)**2) < 20);
        return target ? {x: target.pos.x, y: target.pos.y} : {x, y};
    }

    function handleDraw(x, y, container) {
        if (currentMode === 'pen' && currentTool === 'eraser') return;
        const data = pageData[currentPageId];
        const snapped = getSnappedPos(x, y);

        if(currentMode === 'calib') {
            if(!calibStart) calibStart = {x, y};
            else {
                document.getElementById('scale-px').value = Math.sqrt((x-calibStart.x)**2 + (y-calibStart.y)**2);
                alert("å°ºåº¦è¨­å®šå®Œäº†"); calibStart = null; setMode('manual');
            }
            return;
        }
        if(currentMode === 'mass') {
            const m = document.createElement('div');
            const cfg = MASS_CONFIG[massType];
            m.className = `mass-base mass-${massType} ${cfg.kigu ? 'mass-kigu' : ''}`;
            m.style.left = x + 'px'; m.style.top = y + 'px';
            m.style.transform = `translate(-50%, -50%) rotate(${currentRot}deg)`;
            const txt = document.createElement('span'); txt.className = 'inner-text'; txt.innerText = cfg.label;
            txt.style.transform = `rotate(-${currentRot}deg)`;
            const label = document.createElement('div'); label.className = 'mass-num-label'; label.innerText = data.history.filter(i=>i.isMass).length + 1;
            label.style.transform = `rotate(-${currentRot}deg)`;
            m.appendChild(txt); m.appendChild(label); container.appendChild(m);
            data.history.push({isMass:true, mode:massType, pos:{x,y}, elements:[m]});
        } else if(currentMode === 'manual') {
            if(!manualStart) {
                manualStart = snapped;
                const preview = document.getElementById('line-preview');
                preview.style.display = 'block';
                preview.className = `pipe-line pipe-${currentPipe}`;
            } else {
                createLine(manualStart.x, manualStart.y, snapped.x, snapped.y, container, currentPipe);
                manualStart = null;
                document.getElementById('line-preview').style.display = 'none';
            }
        }
        updateCounters();
    }

    window.addEventListener('mousemove', (e) => {
        if (currentMode === 'manual' && manualStart) {
            const container = document.getElementById('container-' + currentPageId);
            if (!container) return;
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left + container.scrollLeft;
            const y = e.clientY - rect.top + container.scrollTop;
            const snapped = getSnappedPos(x, y);
            const preview = document.getElementById('line-preview');
            const dist = Math.sqrt((snapped.x - manualStart.x)**2 + (snapped.y - manualStart.y)**2);
            preview.style.width = dist + 'px';
            preview.style.left = (manualStart.x + rect.left - container.scrollLeft) + 'px';
            preview.style.top = (manualStart.y + rect.top - container.scrollTop) + 'px';
            preview.style.transform = `rotate(${Math.atan2(snapped.y - manualStart.y, snapped.x - manualStart.x)}rad) translateY(-50%)`;
        }
        if (isMouseDown && currentPath && currentMode === 'pen' && currentTool === 'pen') {
            const container = document.getElementById('container-' + currentPageId);
            const rect = container.querySelector('canvas').getBoundingClientRect();
            const x = e.clientX - rect.left; const y = e.clientY - rect.top;
            const d = currentPath.getAttribute("d");
            currentPath.setAttribute("d", `${d} L ${x} ${y}`);
        }
    });

    window.addEventListener('mouseup', () => { isMouseDown = false; currentPath = null; });

    function createLine(x1, y1, x2, y2, container, type) {
        const dist = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
        if(dist < 2) return;
        const line = document.createElement('div');
        line.className = `pipe-line pipe-${type}`;
        line.style.width = dist + 'px'; line.style.left = x1 + 'px'; line.style.top = y1 + 'px';
        line.style.transform = `rotate(${Math.atan2(y2-y1, x2-x1)}rad) translateY(-50%)`;
        container.appendChild(line);
        pageData[currentPageId].history.push({isMass:false, pipeType:type, elements:[line], len: dist});
    }

    function createPageUI(id, label) {
        const container = document.createElement('div'); container.id='container-'+id; container.className='page-container';
        const canvas = document.createElement('canvas'); canvas.id='canvas-'+id;
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("class", "drawing-svg"); svg.id='svg-'+id;

        canvas.addEventListener('mousedown', (ev) => {
            if(currentMode === 'pen') {
                if(currentTool === 'eraser') return;
                isMouseDown = true;
                currentPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                currentPath.setAttribute("fill", "none"); currentPath.setAttribute("stroke", activePen.color);
                currentPath.setAttribute("stroke-width", activePen.width); currentPath.setAttribute("stroke-linecap", "round");
                currentPath.setAttribute("stroke-linejoin", "round");
                currentPath.setAttribute("d", `M ${ev.offsetX} ${ev.offsetY}`);
                
                // æ¶ˆã—ã‚´ãƒ åˆ¤å®šã‚¤ãƒ™ãƒ³ãƒˆã®ä»˜ä¸
                currentPath.addEventListener('mouseenter', (e) => {
                    if(isMouseDown && currentTool === 'eraser') e.target.remove();
                });
                currentPath.addEventListener('mousedown', (e) => {
                    if(currentTool === 'eraser') {
                        e.stopPropagation();
                        e.target.remove();
                    }
                });

                svg.appendChild(currentPath);
                pageData[id].history.push({elements:[currentPath]});
            } else {
                handleDraw(ev.offsetX, ev.offsetY, container);
            }
        });

        container.appendChild(canvas); container.appendChild(svg);
        document.getElementById('canvas-area').appendChild(container);
        pageData[id] = { history:[] };
        const tab = document.createElement('div'); tab.className='tab-btn'; tab.id='tab-'+id; tab.innerText=label;
        tab.onclick=()=>switchPage(id); document.getElementById('top-tabs').appendChild(tab);
    }

    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(){
            document.getElementById('top-tabs').innerHTML = ''; document.getElementById('canvas-area').innerHTML = '<div id="line-preview"></div>';
            pageData = {};
            if(file.type==="application/pdf"){
                const pdf = await pdfjsLib.getDocument({data: new Uint8Array(this.result)}).promise;
                for(let i=1; i<=pdf.numPages; i++){
                    const id='P'+i; createPageUI(id, 'P'+i);
                    const page = await pdf.getPage(i); const vp = page.getViewport({scale:1.5});
                    const canvas = document.getElementById('canvas-'+id); canvas.width=vp.width; canvas.height=vp.height;
                    await page.render({canvasContext:canvas.getContext('2d'), viewport:vp}).promise;
                }
                switchPage('P1');
            } else {
                createPageUI('P1', 'Image');
                const img = new Image(); img.onload=()=>{ const c=document.getElementById('canvas-P1'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0); }; img.src=URL.createObjectURL(file);
                switchPage('P1');
            }
        };
        reader.readAsArrayBuffer(file);
    };

    function switchPage(id) {
        currentPageId = id;
        document.querySelectorAll('.page-container').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('container-'+id).classList.add('active');
        document.getElementById('tab-'+id).classList.add('active');
    }

    function updateCounters() {
        const pxPerM = parseFloat(document.getElementById('scale-px').value) || 100;
        const stats = { vu100:{l:0}, vu75:{l:0}, vu50:{l:0}, supply:{l:0}, hot:{l:0} };
        let valve = 0, union = 0, tokoS = 0, kabeL = 0;
        Object.values(pageData).forEach(data => {
            data.history.forEach(h => {
                if(h.isMass) {
                    const cfg = MASS_CONFIG[h.mode];
                    if(cfg) { valve += cfg.valve; union += cfg.union; tokoS += cfg.tokoS; kabeL += cfg.kabeL; }
                }
                if(h.len && stats[h.pipeType]) stats[h.pipeType].l += h.len;
            });
        });
        const L100 = stats.vu100.l / pxPerM; const L75 = stats.vu75.l / pxPerM; const L50 = stats.vu50.l / pxPerM;
        document.getElementById('len-vu100').innerText = L100.toFixed(1);
        document.getElementById('len-vu75').innerText = L75.toFixed(1);
        document.getElementById('len-vu50').innerText = L50.toFixed(1);
        document.getElementById('len-supply').innerText = (stats.supply.l / pxPerM).toFixed(1);
        document.getElementById('len-hot').innerText = (stats.hot.l / pxPerM).toFixed(1);
        document.getElementById('qty-vu100').innerText = L100 > 0 ? Math.ceil(L100 / 4) : 0;
        document.getElementById('qty-vu75').innerText = L75 > 0 ? Math.ceil(L75 / 1) : 0;
        document.getElementById('qty-vu50').innerText = L50 > 0 ? Math.ceil(L50 / 1) : 0;
        document.getElementById('parts-valve').innerText = valve; document.getElementById('parts-union').innerText = union;
        document.getElementById('parts-toko-s').innerText = tokoS; document.getElementById('parts-kabe-l').innerText = kabeL;
    }

    function undo() { if(!currentPageId) return; const h = pageData[currentPageId].history; if(h.length>0) h.pop().elements.forEach(e=>e.remove()); updateCounters(); }
    
    function saveAsImage() { 
        html2canvas(document.getElementById('container-'+currentPageId), {scale:2}).then(canvas => { 
            const a = document.createElement('a'); 
            a.href=canvas.toDataURL("image/jpeg",0.9); 
            a.download=`æ‹¾ã„å‡ºã—_${currentPageId}.jpg`; 
            a.click(); 
        }); 
    }
    
    window.addEventListener('keydown', e => { 
        if(e.key === 'r' || e.key === 'R') currentRot = (currentRot + 90) % 360; 
        if(e.ctrlKey && e.key === 'z') undo(); 
    });
    updateUI();
</script>
</body>
</html>
