<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水道屋アプリ v1.4 (戻る機能付)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { background: #333; color: white; padding: 10px; text-align: center; }
        #controls { padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ccc; z-index: 10; font-size: 14px; }
        #canvas-container { flex: 1; position: relative; overflow: auto; background: #ddd; }
        canvas { display: block; cursor: crosshair; }
        .marker { position: absolute; width: 12px; height: 12px; background: rgba(0, 123, 255, 0.8); border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; margin: 2px; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-gray { background: #6c757d; color: white; }
        .btn-red { background: #dc3545; color: white; }
        .active { background: #ffc107 !important; color: black !important; font-weight: bold; }
        .info-text { margin-top: 5px; color: #555; font-weight: bold; }
    </style>
</head>
<body>

<div id="header">水道屋アプリ：戻るボタン追加版</div>

<div id="controls">
    <input type="file" id="upload" accept="image/*,.pdf">
    <hr>
    <button id="scale-btn" class="btn-blue">① スケール設定</button>
    <button id="auto-btn" class="btn-green">② 1mピッチ配置</button>
    <button id="undo-btn" class="btn-gray">↩ 一つ戻る</button>
    <button onclick="location.reload()" class="btn-red">リセット</button>
    <div class="info-text" id="status-msg">図面を読み込んでください</div>
</div>

<div id="canvas-container">
    <canvas id="pdf-canvas"></canvas>
</div>

<script>
    const url = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.workerSrc = url;

    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-container');
    const statusMsg = document.getElementById('status-msg');
    
    let pixelsPerMeter = 0; 
    let mode = 'idle';
    let firstPoint = null;
    let history = []; // 操作の履歴を保存する箱

    // モード切り替え
    document.getElementById('scale-btn').onclick = () => {
        mode = 'settingScale';
        updateUI();
        statusMsg.innerText = "図面上の「1m」の区間を2点クリックしてください";
    };

    document.getElementById('auto-btn').onclick = () => {
        if(pixelsPerMeter === 0) { alert("先に1mの設定が必要です"); return; }
        mode = 'autoPlacing';
        updateUI();
        statusMsg.innerText = "始点と終点をクリック（1m間隔で配置）";
    };

    // ↩ 戻るボタンの処理
    document.getElementById('undo-btn').onclick = () => {
        if (history.length === 0) return;
        
        // 最後に履歴に追加した「マーカーの配列」を取り出す
        const lastAction = history.pop();
        lastAction.forEach(marker => {
            container.removeChild(marker);
        });
        statusMsg.innerText = "一つ前の操作を取り消しました";
    };

    function updateUI() {
        document.getElementById('scale-btn').classList.toggle('active', mode === 'settingScale');
        document.getElementById('auto-btn').classList.toggle('active', mode === 'autoPlacing');
        firstPoint = null;
    }

    document.getElementById('upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.type === "application/pdf") {
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({scale: 2.0});
                canvas.height = viewport.height; canvas.width = viewport.width;
                await page.render({canvasContext: ctx, viewport: viewport}).promise;
                statusMsg.innerText = "読込完了。①でスケールを設定してください";
            };
            reader.readAsArrayBuffer(file);
        }
    });

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if (mode === 'settingScale') {
            if (!firstPoint) { firstPoint = {x, y}; } 
            else {
                pixelsPerMeter = Math.sqrt(Math.pow(x - firstPoint.x, 2) + Math.pow(y - firstPoint.y, 2));
                statusMsg.innerText = "設定完了！ ②が使えます";
                mode = 'idle'; updateUI();
            }
        } else if (mode === 'autoPlacing') {
            if (!firstPoint) {
                firstPoint = {x, y};
                const m = createMarker(x, y);
                history.push([m]); // 履歴に保存
            } else {
                const currentBatch = [];
                const dist = Math.sqrt(Math.pow(x - firstPoint.x, 2) + Math.pow(y - firstPoint.y, 2));
                const steps = Math.floor(dist / pixelsPerMeter);
                for (let i = 1; i <= steps; i++) {
                    const ratio = i / steps;
                    const m = createMarker(firstPoint.x + (x - firstPoint.x) * ratio, firstPoint.y + (y - firstPoint.y) * ratio);
                    currentBatch.push(m);
                }
                history.push(currentBatch); // まとめて履歴に保存
                firstPoint = null;
            }
        }
    });

    function createMarker(x, y) {
        const marker = document.createElement('div');
        marker.className = 'marker';
        marker.style.left = x + 'px';
        marker.style.top = y + 'px';
        container.appendChild(marker);
        return marker;
    }
</script>

</body>
</html>
