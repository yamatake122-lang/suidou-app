<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´é“å±‹ã‚¢ãƒ—ãƒª v1.6 (ã‚µã‚¤ã‚ºåˆ¥å¤ªã•å¯¾å¿œ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { background: #333; color: white; padding: 10px; text-align: center; }
        #controls { padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ccc; z-index: 10; }
        #canvas-container { flex: 1; position: relative; overflow: auto; background: #ddd; }
        canvas { display: block; cursor: crosshair; }
        .marker { position: absolute; width: 10px; height: 10px; border: 1px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .pipe-line { position: absolute; transform-origin: 0 50%; pointer-events: none; opacity: 0.6; }
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; margin: 2px; font-weight: bold; }
        .btn-scale { background: #555; color: white; }
        .btn-undo { background: #eee; color: #333; border: 1px solid #ccc; }
        .group-label { font-size: 12px; color: #333; margin: 5px 2px 2px; font-weight: bold; }
        .selector { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; }
        .type-btn, .size-btn { flex: 1; min-width: 60px; border: 2px solid transparent; }
        .active { border-color: #000 !important; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        #status-msg { font-size: 12px; color: #666; }
    </style>
</head>
<body>

<div id="header">æ°´é“å±‹ã‚¢ãƒ—ãƒªï¼šç®¡å¾„åˆ¥ãƒ«ãƒ¼ãƒˆæç”»</div>

<div id="controls">
    <input type="file" id="upload" accept="image/*,.pdf">
    <button id="scale-btn" class="btn-scale">ğŸ“ ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®š</button>
    <button id="undo-btn" class="btn-undo">â†© æˆ»ã‚‹</button>

    <div class="group-label">1. ç®¡ç¨®ã‚’é¸æŠ</div>
    <div class="selector">
        <button class="type-btn active" data-type="haisui" style="background:#808080; color:white;">æ’æ°´</button>
        <button class="type-btn" data-type="kyusui" style="background:#0000ff; color:white;">çµ¦æ°´</button>
        <button class="type-btn" data-type="kyuto" style="background:#ff0000; color:white;">çµ¦æ¹¯</button>
    </div>

    <div class="group-label">2. ã‚µã‚¤ã‚º(å‘¼ã³å¾„)ã‚’é¸æŠ</div>
    <div id="size-selector" class="selector">
        </div>
    
    <div id="status-msg">â‘ ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šå¾Œã€ç¨®åˆ¥ã¨ã‚µã‚¤ã‚ºã‚’é¸ã‚“ã§ã‚¯ãƒªãƒƒã‚¯</div>
</div>

<div id="canvas-container">
    <canvas id="pdf-canvas"></canvas>
</div>

<script>
    const url = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.workerSrc = url;

    const container = document.getElementById('canvas-container');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const statusMsg = document.getElementById('status-msg');
    const sizeSelector = document.getElementById('size-selector');
    
    let pixelsPerMeter = 0;
    let currentType = 'haisui';
    let currentSize = '75';
    let mode = 'route';
    let firstPoint = null;
    let history = [];

    const config = {
        haisui: { color: '#808080', sizes: { '75': 10, '50': 5 } },
        kyusui: { color: '#0000ff', sizes: { '16': 6, '13': 3 } },
        kyuto:  { color: '#ff0000', sizes: { '16': 6, '13': 3 } }
    };

    // ã‚µã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
    function updateSizeButtons() {
        sizeSelector.innerHTML = '';
        const availableSizes = config[currentType].sizes;
        Object.keys(availableSizes).forEach((size, index) => {
            const btn = document.createElement('button');
            btn.className = 'size-btn' + (index === 0 ? ' active' : '');
            btn.innerText = size;
            btn.style.backgroundColor = config[currentType].color;
            btn.style.color = 'white';
            if (index === 0) currentSize = size;
            btn.onclick = () => {
                document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSize = size;
                firstPoint = null;
            };
            sizeSelector.appendChild(btn);
        });
    }
    updateSizeButtons();

    // ç®¡ç¨®åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.type-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentType = btn.dataset.type;
            updateSizeButtons();
            mode = 'route';
            firstPoint = null;
        };
    });

    document.getElementById('scale-btn').onclick = () => { mode = 'scale'; firstPoint = null; statusMsg.innerText = "1mã®åŒºé–“ã‚’2ç‚¹ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„"; };
    document.getElementById('undo-btn').onclick = () => { if (history.length === 0) return; const lastAction = history.pop(); lastAction.forEach(el => container.removeChild(el)); };

    document.getElementById('upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file && file.type === "application/pdf") {
            const reader = new FileReader();
            reader.onload = async function() {
                const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({scale: 2.0});
                canvas.height = viewport.height; canvas.width = viewport.width;
                await page.render({canvasContext: ctx, viewport: viewport}).promise;
            };
            reader.readAsArrayBuffer(file);
        }
    });

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if (mode === 'scale') {
            if (!firstPoint) { firstPoint = {x, y}; } 
            else {
                pixelsPerMeter = Math.sqrt(Math.pow(x - firstPoint.x, 2) + Math.pow(y - firstPoint.y, 2));
                statusMsg.innerText = "ã‚¹ã‚±ãƒ¼ãƒ«å®Œäº†ï¼ãƒ«ãƒ¼ãƒˆã‚’æã‘ã¾ã™";
                mode = 'route'; firstPoint = null;
            }
        } else if (mode === 'route') {
            if (!firstPoint) { firstPoint = {x, y}; } 
            else {
                if (pixelsPerMeter === 0) { alert("å…ˆã«ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„"); return; }
                const currentBatch = [];
                const dist = Math.sqrt(Math.pow(x - firstPoint.x, 2) + Math.pow(y - firstPoint.y, 2));
                const angle = Math.atan2(y - firstPoint.y, x - firstPoint.x);
                const thickness = config[currentType].sizes[currentSize];

                const line = document.createElement('div');
                line.className = 'pipe-line';
                line.style.width = dist + 'px';
                line.style.height = thickness + 'px'; // ã‚µã‚¤ã‚ºã«å¿œã˜ãŸå¤ªã•
                line.style.backgroundColor = config[currentType].color;
                line.style.left = firstPoint.x + 'px';
                line.style.top = firstPoint.y + 'px';
                line.style.transform = `rotate(${angle}rad) translateY(-50%)`;
                container.appendChild(line);
                currentBatch.push(line);

                const steps = Math.floor(dist / pixelsPerMeter);
                for (let i = 0; i <= steps; i++) {
                    const ratio = i / (steps || 1);
                    const m = document.createElement('div');
                    m.className = 'marker';
                    m.style.backgroundColor = config[currentType].color;
                    m.style.left = (firstPoint.x + (x - firstPoint.x) * ratio) + 'px';
                    m.style.top = (firstPoint.y + (y - firstPoint.y) * ratio) + 'px';
                    container.appendChild(m);
                    currentBatch.push(m);
                }
                history.push(currentBatch);
                firstPoint = null;
            }
        }
    });
</script>

</body>
</html>
