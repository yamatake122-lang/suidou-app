<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¨­å‚™æ‹¾ã„å‡ºã—ãƒ„ãƒ¼ãƒ« v10.8 Pro (Split Workflow)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --sidebar-width: 280px; }
        body { font-family: 'Segoe UI', Meiryo, sans-serif; margin: 0; display: flex; height: 100vh; background: #1a1a1a; color: white; overflow: hidden; }
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar { width: var(--sidebar-width); background: #252525; border-right: 2px solid #444; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; overflow-y: auto; z-index: 1000; }
        .sidebar-section { margin-bottom: 20px; padding: 10px; background: #333; border-radius: 8px; border: 1px solid #444; }
        .sidebar-title { font-size: 11px; font-weight: bold; color: #00d2ff; margin-bottom: 8px; border-bottom: 1px solid #555; padding-bottom: 3px; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        #main-content { flex: 1; display: flex; flex-direction: column; background: #333; position: relative; overflow: hidden; }
        #top-tabs { display: flex; background: #222; border-bottom: 1px solid #444; overflow-x: auto; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border-right: 1px solid #444; background: #333; color: #aaa; font-size: 11px; }
        .tab-btn.active { background: #007bff; color: white; font-weight: bold; }
        
        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨æç”»ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #canvas-area { flex: 1; overflow: auto; padding: 20px; display: flex; align-items: flex-start; justify-content: center; position: relative; }
        .page-container { position: relative; display: none; background: white; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        .page-container.active { display: block; }
        canvas { display: block; cursor: crosshair; }
        .drawing-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }

        /* ãƒœã‚¿ãƒ³ãƒ»ãƒ‘ãƒ¬ãƒƒãƒˆ */
        button { width: 100%; padding: 8px; margin-bottom: 4px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 10px; text-align: left; background: #444; color: #ccc; }
        button.active-sel { background: #007bff; color: white; box-shadow: 0 0 8px rgba(0,123,255,0.5); }
        
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 5px 0; }
        .color-dot { width: 100%; height: 22px; border-radius: 4px; border: 2px solid transparent; cursor: pointer; }
        .color-dot.active { border-color: white; transform: scale(1.1); }
        
        .size-grid { display: flex; gap: 4px; }
        .size-btn { flex: 1; background: #555; color: white; border: none; padding: 4px; border-radius: 4px; cursor: pointer; font-size: 9px; text-align: center; }
        .size-btn.active { background: #28a745; }

        /* é›†è¨ˆãƒ‘ãƒãƒ« */
        #counter-panel { position: absolute; top: 50px; right: 10px; background: rgba(0,0,0,0.9); border: 1px solid #444; padding: 12px; border-radius: 8px; font-size: 11px; z-index: 2000; min-width: 180px; }
        .cnt-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; }
        
        /* é…ç®¡ãƒ»ãƒã‚¹ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆCSSï¼‰ */
        .mass-base { position: absolute; width: 24px; height: 24px; border: 2px solid #333; border-radius: 50%; background: white; transform: translate(-50%, -50%); pointer-events: none; z-index: 20; }
        .pipe-line { position: absolute; transform-origin: 0 50%; pointer-events: none; opacity: 0.7; z-index: 10; }
        .pipe-vu100 { height: 8px; background: #28a745; }
        .pipe-supply { height: 4px; background: #007bff; }
    </style>
</head>
<body>

<div id="sidebar">
    <button style="background:#eee;color:#111;text-align:center;margin-bottom:15px;" onclick="document.getElementById('file-input').click()">ğŸ“ å›³é¢èª­ã¿è¾¼ã¿(PDF/ç”»åƒ)</button>
    <input type="file" id="file-input" style="display:none;" accept=".pdf,image/*">
    
    <div class="sidebar-section">
        <div class="sidebar-title">â‘  æ‹¾ã„å‡ºã—ã‚³ãƒãƒ³ãƒ‰</div>
        <button id="mode-manual" onclick="setMode('manual')" class="active-sel">ğŸ“ ç›´ç·šé…ç®¡ (é›†è¨ˆå¯¾è±¡)</button>
        <button id="mode-mass" onclick="setMode('mass')">ğŸ”˜ ãƒã‚¹/å™¨å…· é…ç½®</button>
        <div style="margin-top:8px;">
            <select id="pipe-type-sel" style="width:100%; background:#444; color:white; border:none; padding:5px; font-size:10px;">
                <option value="vu100">ğŸŸ© VU100 (æ’æ°´)</option>
                <option value="supply">ğŸŸ¦ VP (çµ¦æ°´)</option>
                <option value="hot">ğŸŸ¥ HT (çµ¦æ¹¯)</option>
            </select>
        </div>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-title">â‘¡ å›³é¢æ³¨è¨˜ (è‡ªç”±ãƒšãƒ³)</div>
        <button id="mode-pen" onclick="setMode('pen')">ğŸ–Š ãƒšãƒ³æ›¸ããƒ¢ãƒ¼ãƒ‰èµ·å‹•</button>
        <div class="color-grid">
            <div class="color-dot active" style="background:#000000" onclick="setPenStyle('#000000', null)"></div>
            <div class="color-dot" style="background:#ff0000" onclick="setPenStyle('#ff0000', null)"></div>
            <div class="color-dot" style="background:#007bff" onclick="setPenStyle('#007bff', null)"></div>
            <div class="color-dot" style="background:#28a745" onclick="setPenStyle('#28a745', null)"></div>
            <div class="color-dot" style="background:#ffc107" onclick="setPenStyle('#ffc107', null)"></div>
            <div class="color-dot" style="background:#9c27b0" onclick="setPenStyle('#9c27b0', null)"></div>
            <div class="color-dot" style="background:#ffffff; border:1px solid #666;" onclick="setPenStyle('#ffffff', null)"></div>
        </div>
        <div class="size-grid">
            <button class="size-btn active" onclick="setPenStyle(null, 2)">ç´°</button>
            <button class="size-btn" onclick="setPenStyle(null, 5)">ä¸­</button>
            <button class="size-btn" onclick="setPenStyle(null, 12)">å¤ª</button>
        </div>
    </div>

    <button onclick="undo()" style="background:#6c757d;color:white;text-align:center;margin-top:10px;">â†© 1ã¤æˆ»ã™ (Ctrl+Z)</button>
    <button onclick="saveAsImage()" style="background:#28a745;color:white;text-align:center;margin-top:10px;">ğŸ“¸ ç”»åƒã¨ã—ã¦ä¿å­˜</button>
</div>

<div id="main-content">
    <div id="top-tabs"></div>
    <div id="canvas-area"></div>
    
    <div id="counter-panel">
        <div style="color:#00d2ff; font-weight:bold; margin-bottom:5px;">é›†è¨ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div class="cnt-row"><span>é…ç®¡åˆè¨ˆ:</span> <span><span id="total-len">0.0</span> m</span></div>
    </div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let currentPageId = null, pageData = {};
    let currentMode = 'manual'; // åˆæœŸå€¤ã¯æ‹¾ã„å‡ºã—
    let activePen = { color: '#000000', width: 2 };
    let isMouseDown = false, currentPath = null, manualStart = null;

    function setMode(m) {
        currentMode = m;
        manualStart = null;
        document.querySelectorAll('button').forEach(b => b.classList.remove('active-sel'));
        document.getElementById('mode-'+m)?.classList.add('active-sel');
    }

    function setPenStyle(color, width) {
        if(color) activePen.color = color;
        if(width) activePen.width = width;
        setMode('pen');
        // UIæ›´æ–°
        if(color) {
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            event.target.classList.add('active');
        }
        if(width) {
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
    }

    function createPageUI(id, label) {
        const area = document.getElementById('canvas-area');
        const container = document.createElement('div');
        container.id = 'container-' + id;
        container.className = 'page-container';
        
        const canvas = document.createElement('canvas');
        canvas.id = 'canvas-' + id;
        
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("class", "drawing-svg");
        svg.id = 'svg-' + id;

        container.onmousedown = (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (currentMode === 'pen') {
                isMouseDown = true;
                currentPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                currentPath.setAttribute("fill", "none");
                currentPath.setAttribute("stroke", activePen.color);
                currentPath.setAttribute("stroke-width", activePen.width);
                currentPath.setAttribute("stroke-linecap", "round");
                currentPath.setAttribute("stroke-linejoin", "round");
                currentPath.setAttribute("d", `M ${x} ${y}`);
                svg.appendChild(currentPath);
                pageData[id].history.push({ type: 'pen', elements: [currentPath] });
            } else if (currentMode === 'manual') {
                if (!manualStart) {
                    manualStart = { x, y };
                } else {
                    const type = document.getElementById('pipe-type-sel').value;
                    const dist = Math.sqrt((x-manualStart.x)**2 + (y-manualStart.y)**2);
                    const line = document.createElement('div');
                    line.className = `pipe-line pipe-${type}`;
                    line.style.width = dist + 'px';
                    line.style.left = manualStart.x + 'px';
                    line.style.top = manualStart.y + 'px';
                    line.style.transform = `rotate(${Math.atan2(y-manualStart.y, x-manualStart.x)}rad) translateY(-50%)`;
                    container.appendChild(line);
                    pageData[id].history.push({ type: 'pipe', len: dist, elements: [line] });
                    manualStart = null;
                    updateTotal();
                }
            } else if (currentMode === 'mass') {
                const m = document.createElement('div');
                m.className = 'mass-base';
                m.style.left = x + 'px'; m.style.top = y + 'px';
                container.appendChild(m);
                pageData[id].history.push({ type: 'mass', elements: [m] });
            }
        };

        window.addEventListener('mousemove', (e) => {
            if (!isMouseDown || !currentPath || currentMode !== 'pen') return;
            const rect = document.getElementById('canvas-' + currentPageId).getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const d = currentPath.getAttribute("d");
            currentPath.setAttribute("d", `${d} L ${x} ${y}`);
        });

        window.addEventListener('mouseup', () => { isMouseDown = false; currentPath = null; });

        container.appendChild(canvas);
        container.appendChild(svg);
        area.appendChild(container);
        pageData[id] = { history: [] };
        
        const tab = document.createElement('div');
        tab.className = 'tab-btn'; tab.id = 'tab-' + id; tab.innerText = label;
        tab.onclick = () => switchPage(id);
        document.getElementById('top-tabs').appendChild(tab);
    }

    function updateTotal() {
        let total = 0;
        Object.values(pageData).forEach(p => {
            p.history.forEach(h => { if(h.len) total += h.len; });
        });
        document.getElementById('total-len').innerText = (total / 100).toFixed(1); // ç°¡æ˜“å°º
    }

    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(){
            document.getElementById('top-tabs').innerHTML = '';
            document.getElementById('canvas-area').innerHTML = '';
            const pdf = await pdfjsLib.getDocument({data: new Uint8Array(this.result)}).promise;
            for(let i=1; i<=pdf.numPages; i++){
                const id='P'+i; createPageUI(id, 'P'+i);
                const page = await pdf.getPage(i); const vp = page.getViewport({scale:1.5});
                const canvas = document.getElementById('canvas-'+id); canvas.width=vp.width; canvas.height=vp.height;
                await page.render({canvasContext:canvas.getContext('2d'), viewport:vp}).promise;
            }
            switchPage('P1');
        };
        reader.readAsArrayBuffer(file);
    };

    function switchPage(id) {
        currentPageId = id;
        document.querySelectorAll('.page-container').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('container-'+id).classList.add('active');
        document.getElementById('tab-'+id).classList.add('active');
    }

    function undo() {
        if (!currentPageId) return;
        const h = pageData[currentPageId].history;
        if (h.length > 0) {
            h.pop().elements.forEach(e => e.remove());
            updateTotal();
        }
    }

    function saveAsImage() {
        html2canvas(document.getElementById('container-'+currentPageId)).then(canvas => {
            const a = document.createElement('a'); a.href=canvas.toDataURL("image/jpeg"); a.download="å›³é¢å‡ºåŠ›.jpg"; a.click();
        });
    }
</script>
</body>
</html>
