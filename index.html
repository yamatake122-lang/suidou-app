<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水道屋アプリ v1.2 (自動配置)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { background: #333; color: white; padding: 10px; text-align: center; }
        #controls { padding: 15px; background: #f9f9f9; border-top: 1px solid #ddd; z-index: 10; }
        #canvas-container { flex: 1; position: relative; overflow: auto; background: #eee; }
        canvas { display: block; cursor: crosshair; }
        .marker { position: absolute; width: 14px; height: 14px; background: rgba(0, 123, 255, 0.7); border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .line { position: absolute; background: rgba(0, 123, 255, 0.3); height: 2px; transform-origin: 0 0; pointer-events: none; }
        button { padding: 10px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 5px; margin-right: 5px; }
        .active { background: #ffc107; color: black; }
    </style>
</head>
<body>

<div id="header">水道屋アプリ：スリーブ自動配置</div>

<div id="controls">
    <input type="file" id="upload" accept="image/*,.pdf">
    <button id="mode-btn">単発配置モード</button>
    <span> 合計: <b id="count">0</b> 個</span>
    <button onclick="location.reload()" style="background:#dc3545">リセット</button>
    <p style="font-size: 0.8em; margin: 5px 0 0;">※自動配置：2箇所クリックで間を埋めます（現在はデモ用ピッチ）</p>
</div>

<div id="canvas-container" id="container">
    <canvas id="pdf-canvas"></canvas>
</div>

<script>
    const url = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.workerSrc = url;

    const upload = document.getElementById('upload');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-container');
    const countSpan = document.getElementById('count');
    const modeBtn = document.getElementById('mode-btn');

    let markerCount = 0;
    let isAutoMode = false;
    let firstPoint = null;

    modeBtn.onclick = () => {
        isAutoMode = !isAutoMode;
        modeBtn.innerText = isAutoMode ? "自動配置モード中" : "単発配置モード";
        modeBtn.className = isAutoMode ? "active" : "";
        firstPoint = null;
    };

    upload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.type === "application/pdf") {
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({scale: 1.5});
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({canvasContext: ctx, viewport: viewport}).promise;
            };
            reader.readAsArrayBuffer(file);
        } else {
            const img = new Image();
            img.onload = () => { canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); };
            img.src = URL.createObjectURL(file);
        }
    });

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if (isAutoMode) {
            if (!firstPoint) {
                firstPoint = {x, y};
                addMarker(x, y);
            } else {
                // A点からB点の間を等間隔(50px)で埋める
                const dist = Math.sqrt(Math.pow(x - firstPoint.x, 2) + Math.pow(y - firstPoint.y, 2));
                const steps = Math.floor(dist / 50); // デモ用ピッチ
                for (let i = 1; i <= steps; i++) {
                    const ratio = i / steps;
                    const mx = firstPoint.x + (x - firstPoint.x) * ratio;
                    const my = firstPoint.y + (y - firstPoint.y) * ratio;
                    addMarker(mx, my);
                }
                firstPoint = null; 
            }
        } else {
            addMarker(x, y);
        }
    });

    function addMarker(x, y) {
        const marker = document.createElement('div');
        marker.className = 'marker';
        marker.style.left = x + 'px';
        marker.style.top = y + 'px';
        container.appendChild(marker);
        markerCount++;
        countSpan.innerText = markerCount;
    }
</script>

</body>
</html>
