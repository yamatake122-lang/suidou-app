<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è¨­å‚™æ‹¾ã„å‡ºã—ãƒ„ãƒ¼ãƒ« v10.7 Pro (Full Pen Control)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --sidebar-width: 280px; }
        body { font-family: 'Segoe UI', Meiryo, sans-serif; margin: 0; display: flex; height: 100vh; background: #1a1a1a; color: white; overflow: hidden; }
        #sidebar { width: var(--sidebar-width); background: #252525; border-right: 2px solid #444; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; overflow-y: auto; z-index: 1000; }
        #main-content { flex: 1; display: flex; flex-direction: column; background: #333; position: relative; overflow: hidden; }
        #top-tabs { display: flex; background: #222; border-bottom: 1px solid #444; overflow-x: auto; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border-right: 1px solid #444; background: #333; color: #aaa; font-size: 11px; }
        .tab-btn.active { background: #007bff; color: white; font-weight: bold; }
        #canvas-area { flex: 1; overflow: auto; padding: 20px; display: flex; align-items: flex-start; justify-content: center; position: relative; }
        .page-container { position: relative; display: none; background: white; box-shadow: 0 0 30px rgba(0,0,0,0.7); }
        .page-container.active { display: block; }
        canvas { display: block; cursor: crosshair; }
        
        /* è‡ªç”±æ‰‹æ›¸ããƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .drawing-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        
        .sidebar-section { margin-bottom: 15px; }
        .sidebar-title { font-size: 11px; font-weight: bold; color: #888; margin-bottom: 5px; border-bottom: 1px solid #444; }
        
        /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .color-dot { width: 100%; height: 25px; border-radius: 4px; border: 2px solid transparent; cursor: pointer; }
        .color-dot.active { border-color: white; transform: scale(1.1); }

        /* å¤ªã•é¸æŠ */
        .size-grid { display: flex; gap: 5px; margin-bottom: 10px; }
        .size-btn { flex: 1; background: #444; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .size-btn.active { background: #007bff; }

        button.mode-btn { width: 100%; padding: 8px; margin-bottom: 4px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 10px; text-align: left; background: #444; color: #ccc; }
        button.mode-btn.active-sel { background: #007bff; color: white; border: 1px solid #fff; }
    </style>
</head>
<body>

<div id="sidebar">
    <button style="background:#eee;color:#111;text-align:center;font-weight:bold;margin-bottom:15px;" onclick="document.getElementById('file-input').click()">ğŸ“ å›³é¢èª­ã¿è¾¼ã¿</button>
    <input type="file" id="file-input" style="display:none;" accept=".pdf,image/*">
    
    <div class="sidebar-section">
        <div class="sidebar-title">â‘  æç”»ãƒ¢ãƒ¼ãƒ‰</div>
        <button id="mode-pen" class="mode-btn" onclick="setMode('pen')">ğŸ–Š è‡ªç”±æ‰‹æ›¸ã</button>
        <button id="mode-manual" class="mode-btn" onclick="setMode('manual')">ğŸ“ ç›´ç·šé…ç®¡</button>
        <button id="mode-mass" class="mode-btn" onclick="setMode('mass')">ğŸ”˜ ãƒã‚¹/å™¨å…· é…ç½®</button>
    </div>

    <div class="sidebar-section" id="pen-settings">
        <div class="sidebar-title">â‘¡ ãƒšãƒ³è¨­å®š (7è‰²)</div>
        <div class="color-grid">
            <div class="color-dot active" style="background:#000000" onclick="setPenColor('#000000', this)"></div>
            <div class="color-dot" style="background:#ff0000" onclick="setPenColor('#ff0000', this)"></div>
            <div class="color-dot" style="background:#007bff" onclick="setPenColor('#007bff', this)"></div>
            <div class="color-dot" style="background:#28a745" onclick="setPenColor('#28a745', this)"></div>
            <div class="color-dot" style="background:#ffc107" onclick="setPenColor('#ffc107', this)"></div>
            <div class="color-dot" style="background:#9c27b0" onclick="setPenColor('#9c27b0', this)"></div>
            <div class="color-dot" style="background:#ff9800" onclick="setPenColor('#ff9800', this)"></div>
            <div class="color-dot" style="background:#ffffff; border:1px solid #444;" onclick="setPenColor('#ffffff', this)"></div>
        </div>
        <div class="sidebar-title">â‘¢ ãƒšãƒ³ã®å¤ªã•</div>
        <div class="size-grid">
            <button class="size-btn active" onclick="setPenWidth(2, this)">ç´°</button>
            <button class="size-btn" onclick="setPenWidth(5, this)">ä¸­</button>
            <button class="size-btn" onclick="setPenWidth(10, this)">å¤ª</button>
        </div>
    </div>

    <button onclick="undo()" style="background:#6c757d;color:white;text-align:center;margin-top:20px;">â†© 1ã¤æˆ»ã™ (Ctrl+Z)</button>
    <button onclick="saveAsImage()" style="background:#28a745;color:white;text-align:center;margin-top:10px;">ğŸ“¸ ç”»åƒã¨ã—ã¦ä¿å­˜</button>
</div>

<div id="main-content">
    <div id="top-tabs"></div>
    <div id="canvas-area"></div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let currentPageId = null, pageData = {};
    let currentMode = 'pen', activeColor = '#000000', activeWidth = 2;
    let isMouseDown = false, currentPath = null;

    function setMode(m) { 
        currentMode = m; 
        updateUI(); 
    }

    function setPenColor(color, el) {
        activeColor = color;
        currentMode = 'pen';
        document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
        el.classList.add('active');
        updateUI();
    }

    function setPenWidth(width, el) {
        activeWidth = width;
        currentMode = 'pen';
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        updateUI();
    }

    function updateUI() {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-sel'));
        document.getElementById('mode-'+currentMode)?.classList.add('active-sel');
        // ãƒšãƒ³è¨­å®šã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        document.getElementById('pen-settings').style.opacity = (currentMode === 'pen') ? '1' : '0.5';
    }

    function createPageUI(id, label) {
        const area = document.getElementById('canvas-area');
        const container = document.createElement('div');
        container.id = 'container-' + id;
        container.className = 'page-container';
        
        const canvas = document.createElement('canvas');
        canvas.id = 'canvas-' + id;
        
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("class", "drawing-svg");
        svg.id = 'svg-' + id;

        container.onmousedown = (e) => {
            if (currentMode !== 'pen') return;
            isMouseDown = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            currentPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            currentPath.setAttribute("fill", "none");
            currentPath.setAttribute("stroke", activeColor);
            currentPath.setAttribute("stroke-width", activeWidth);
            currentPath.setAttribute("stroke-linecap", "round");
            currentPath.setAttribute("stroke-linejoin", "round");
            currentPath.setAttribute("d", `M ${x} ${y}`);
            svg.appendChild(currentPath);
            pageData[id].history.push({ elements: [currentPath] });
        };

        window.addEventListener('mousemove', (e) => {
            if (!isMouseDown || !currentPath || currentMode !== 'pen') return;
            const containerActive = document.getElementById('container-' + currentPageId);
            const rect = containerActive.querySelector('canvas').getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const d = currentPath.getAttribute("d");
            currentPath.setAttribute("d", `${d} L ${x} ${y}`);
        });

        window.addEventListener('mouseup', () => {
            isMouseDown = false;
            currentPath = null;
        });

        container.appendChild(canvas);
        container.appendChild(svg);
        area.appendChild(container);
        pageData[id] = { history: [] };
        
        const tab = document.createElement('div');
        tab.className = 'tab-btn'; tab.id = 'tab-' + id; tab.innerText = label;
        tab.onclick = () => switchPage(id);
        document.getElementById('top-tabs').appendChild(tab);
    }

    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(){
            document.getElementById('top-tabs').innerHTML = '';
            document.getElementById('canvas-area').innerHTML = '';
            const pdf = await pdfjsLib.getDocument({data: new Uint8Array(this.result)}).promise;
            for(let i=1; i<=pdf.numPages; i++){
                const id='P'+i; createPageUI(id, 'Page '+i);
                const page = await pdf.getPage(i); const vp = page.getViewport({scale:1.5});
                const canvas = document.getElementById('canvas-'+id); canvas.width=vp.width; canvas.height=vp.height;
                await page.render({canvasContext:canvas.getContext('2d'), viewport:vp}).promise;
            }
            switchPage('P1');
        };
        reader.readAsArrayBuffer(file);
    };

    function switchPage(id) {
        currentPageId = id;
        document.querySelectorAll('.page-container').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('container-'+id).classList.add('active');
        document.getElementById('tab-'+id).classList.add('active');
    }

    function undo() {
        if (!currentPageId) return;
        const h = pageData[currentPageId].history;
        if (h.length > 0) h.pop().elements.forEach(e => e.remove());
    }

    function saveAsImage() {
        if(!currentPageId) return;
        html2canvas(document.getElementById('container-'+currentPageId)).then(canvas => {
            const a = document.createElement('a'); a.href=canvas.toDataURL("image/jpeg"); a.download=`å›³é¢_${currentPageId}.jpg`; a.click();
        });
    }

    updateUI();
</script>
</body>
</html>
